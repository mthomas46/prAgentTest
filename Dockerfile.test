FROM node:18

WORKDIR /app

# Install Java for Liquibase
RUN apt-get update && \
    apt-get install -y default-jre postgresql-client wget && \
    wget https://github.com/liquibase/liquibase/releases/download/v4.25.1/liquibase-4.25.1.tar.gz && \
    mkdir -p /opt/liquibase && \
    tar -xzf liquibase-4.25.1.tar.gz -C /opt/liquibase && \
    ln -s /opt/liquibase/liquibase /usr/local/bin/liquibase && \
    rm liquibase-4.25.1.tar.gz

# Install dependencies
COPY package*.json ./
RUN npm ci

# Copy source code
COPY . .

# Build the application
RUN npm run build

# Copy Liquibase properties
COPY liquibase.properties /app/liquibase.properties

# Set environment variables
ENV NODE_ENV=test
ENV DB_HOST=db-test
ENV DB_PORT=5432
ENV DB_USERNAME=postgres
ENV DB_PASSWORD=postgres
ENV DB_DATABASE=test

# Run tests
CMD ["npm", "run", "test"] 